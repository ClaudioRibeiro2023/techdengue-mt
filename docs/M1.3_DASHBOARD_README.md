# M1.3 - Dashboard EPI (KPIs + GrÃ¡ficos)

## ğŸ“Š VisÃ£o Geral

Sistema completo de **Dashboard EpidemiolÃ³gico** com KPIs dinÃ¢micos, grÃ¡ficos interativos e rankings para anÃ¡lise de indicadores de dengue, zika, chikungunya e febre amarela no Estado de Mato Grosso.

**Status**: âœ… **100% COMPLETO** | Production Ready  
**Data ConclusÃ£o**: 2024-11-02  
**VersÃ£o**: 1.0.0

---

## ğŸ¯ Objetivos AlcanÃ§ados

- âœ… **3 APIs REST** para KPIs, sÃ©ries temporais e rankings
- âœ… **Backend completo** com cÃ¡lculos de indicadores e agregaÃ§Ãµes
- âœ… **Frontend React** com componentes reutilizÃ¡veis
- âœ… **VisualizaÃ§Ãµes interativas** (cards, grÃ¡ficos de linha e barras)
- âœ… **Filtros dinÃ¢micos** (ano, semana epi, doenÃ§a)
- âœ… **ComparaÃ§Ã£o temporal** (variaÃ§Ãµes vs perÃ­odo anterior)

---

## ğŸ“¦ Componentes Implementados

### 1. Backend - Schemas (450 linhas)

**Arquivo**: `epi-api/app/schemas/dashboard.py`

#### Enums
- `DoencaTipo`: DENGUE, ZIKA, CHIKUNGUNYA, FEBRE_AMARELA
- `PeriodoAgregacao`: DIARIO, SEMANAL, MENSAL, ANUAL
- `TendenciaDirecao`: ALTA, BAIXA, ESTAVEL

#### Schemas KPIs
- `KPIVariacao`: VariaÃ§Ã£o temporal com percentual e tendÃªncia
- `KPICard`: Card individual de KPI com Ã­cone, cor e descriÃ§Ã£o
- `DashboardKPIs`: Conjunto completo de KPIs (4 principais + 2 secundÃ¡rios)

#### Schemas SÃ©ries Temporais
- `PontoSerie`: Ponto individual (data + valor)
- `SerieTemporal`: SÃ©rie completa com metadados
- `SeriesTemporaisResponse`: Response com mÃºltiplas sÃ©ries

#### Schemas Rankings
- `ItemRanking`: Item individual do ranking (posiÃ§Ã£o, municÃ­pio, valor, risco)
- `TopNResponse`: Response com ranking completo

#### Schemas Drill-Down
- `DrillDownFiltro`: Filtros para detalhamento
- `DrillDownDados`: Dados agregados com distribuiÃ§Ãµes
- `ComparativoMunicipio`: ComparaÃ§Ã£o entre municÃ­pios

---

### 2. Backend - Service (700 linhas)

**Arquivo**: `epi-api/app/services/dashboard_service.py`

#### MÃ©todos Principais

##### `get_kpis()`
Calcula KPIs principais do dashboard

**Retorna**:
- Total de Casos (com variaÃ§Ã£o %)
- Total de Ã“bitos
- Taxa de Letalidade
- IncidÃªncia MÃ©dia (/100k hab)
- MunicÃ­pios em Alto Risco (opcional)
- Casos Graves (opcional)

**Features**:
- ComparaÃ§Ã£o com perÃ­odo anterior (mesmo intervalo, ano anterior)
- CÃ¡lculo automÃ¡tico de tendÃªncia (alta/baixa/estÃ¡vel)
- Threshold de 5% para definir se estÃ¡vel

##### `get_series_temporais()`
Gera sÃ©ries temporais de indicadores

**AgregaÃ§Ãµes**:
- Semanal (por semana epidemiolÃ³gica)
- Mensal (por mÃªs)
- Anual (por ano)

**SÃ©ries**:
- Casos confirmados
- Ã“bitos

**Filtros**:
- Por doenÃ§a (opcional)
- Por municÃ­pio (opcional)

##### `get_top_n()`
Retorna ranking Top N de municÃ­pios

**Indicadores**:
- Casos (total de casos confirmados)
- IncidÃªncia (/100k habitantes)
- Ã“bitos (total de Ã³bitos)

**Inclui**:
- PosiÃ§Ã£o no ranking
- Valor do indicador
- % do total estadual
- ClassificaÃ§Ã£o de risco
- Cor para visualizaÃ§Ã£o

##### `_calc_variacao()`
Calcula variaÃ§Ã£o entre perÃ­odos

**LÃ³gica**:
- VariaÃ§Ã£o absoluta
- VariaÃ§Ã£o percentual
- TendÃªncia (ALTA se >5%, BAIXA se <-5%, ESTAVEL se entre -5% e 5%)

##### `_classificar_risco_incidencia()`
Classifica risco baseado na incidÃªncia

**Thresholds**:
- BAIXO: < 100 casos/100k (verde)
- MÃ‰DIO: 100-300 casos/100k (amarelo)
- ALTO: 300-500 casos/100k (laranja)
- MUITO_ALTO: â‰¥ 500 casos/100k (vermelho)

---

### 3. Backend - Router (350 linhas)

**Arquivo**: `epi-api/app/routers/dashboard.py`

#### Endpoints

##### GET /api/indicadores/kpis

**Query Params**:
- `ano` (obrigatÃ³rio): 2000-2100
- `semana_epi_inicio` (opcional): 1-53
- `semana_epi_fim` (opcional): 1-53
- `doenca_tipo` (opcional): DENGUE | ZIKA | CHIKUNGUNYA | FEBRE_AMARELA
- `comparar_periodo_anterior` (opcional): true | false (default: true)

**Response**: `DashboardKPIs`

**Exemplo**:
```bash
curl "http://localhost:8000/api/indicadores/kpis?ano=2024"
```

##### GET /api/indicadores/series-temporais

**Query Params**:
- `ano` (obrigatÃ³rio): 2000-2100
- `periodo_agregacao` (opcional): semanal | mensal | anual (default: semanal)
- `doenca_tipo` (opcional): DENGUE | ZIKA | CHIKUNGUNYA | FEBRE_AMARELA
- `codigo_ibge` (opcional): 7 dÃ­gitos para filtrar por municÃ­pio

**Response**: `SeriesTemporaisResponse`

**Exemplo**:
```bash
curl "http://localhost:8000/api/indicadores/series-temporais?ano=2024&periodo_agregacao=mensal&doenca_tipo=DENGUE"
```

##### GET /api/indicadores/top

**Query Params**:
- `ano` (obrigatÃ³rio): 2000-2100
- `limite` (opcional): 1-50 (default: 10)
- `tipo_indicador` (opcional): casos | incidencia | obitos (default: casos)
- `semana_epi_inicio` (opcional): 1-53
- `semana_epi_fim` (opcional): 1-53
- `doenca_tipo` (opcional): DENGUE | ZIKA | CHIKUNGUNYA | FEBRE_AMARELA

**Response**: `TopNResponse`

**Exemplo**:
```bash
curl "http://localhost:8000/api/indicadores/top?ano=2024&tipo_indicador=incidencia&limite=5"
```

---

### 4. Frontend - Componentes React

#### DashboardEPI Page (220 linhas)

**Arquivo**: `frontend/src/pages/DashboardEPI.tsx`

**Features**:
- Filtros dinÃ¢micos (ano, semanas, doenÃ§a)
- Fetch automÃ¡tico de dados (useEffect)
- Loading states
- Error handling
- Layout responsivo (grid)

**Estrutura**:
- Header com tÃ­tulo e descriÃ§Ã£o
- SeÃ§Ã£o de filtros (4 campos)
- Grid de KPI cards
- Grid de grÃ¡ficos (2 colunas)
- Footer com metadados (Ãºltima atualizaÃ§Ã£o, perÃ­odo)

#### KPICards Component (130 linhas)

**Arquivo**: `frontend/src/components/dashboard/KPICards.tsx`

**Features**:
- Cards coloridos com borda superior
- Ãcones Lucide React
- VariaÃ§Ã£o com setas (â†‘ â†“ â†’)
- Cores baseadas em tendÃªncia
- Grid responsivo (1-4 colunas)

**KPIs Exibidos**:
- Total de Casos
- Total de Ã“bitos
- Taxa de Letalidade
- IncidÃªncia MÃ©dia
- MunicÃ­pios Alto Risco (se > 0)
- Casos Graves (se > 0)

#### TimeSeriesChart Component (140 linhas)

**Arquivo**: `frontend/src/components/dashboard/TimeSeriesChart.tsx`

**Features**:
- GrÃ¡fico de linha (Chart.js)
- MÃºltiplas sÃ©ries sobrepostas
- Tooltip com detalhes
- Cores customizadas por sÃ©rie
- Zoom/pan (via Chart.js plugins)
- Labels formatados (pt-BR)

**Tecnologias**:
- react-chartjs-2
- chart.js

#### TopNChart Component (180 linhas)

**Arquivo**: `frontend/src/components/dashboard/TopNChart.tsx`

**Features**:
- GrÃ¡fico de barras horizontais
- Cores por nÃ­vel de risco
- Tooltip detalhado (valor, %, risco)
- Lista textual dos top 5
- Cards com posiÃ§Ã£o, municÃ­pio e valor

**Tecnologias**:
- react-chartjs-2
- chart.js

---

## ğŸš€ Como Usar

### Backend

1. **Instalar dependÃªncias**:
```bash
cd epi-api
pip install -r requirements.txt
```

2. **Configurar variÃ¡veis de ambiente**:
```bash
export DATABASE_URL="postgresql://techdengue:techdengue@localhost:5432/techdengue"
```

3. **Iniciar servidor**:
```bash
uvicorn app.main:app --reload
```

4. **Acessar OpenAPI docs**:
```
http://localhost:8000/docs
```

### Frontend

1. **Instalar dependÃªncias**:
```bash
cd frontend
npm install
# Instalar Chart.js se nÃ£o estiver no package.json
npm install react-chartjs-2 chart.js
```

2. **Configurar .env**:
```bash
VITE_API_URL=http://localhost:8000/api
```

3. **Iniciar dev server**:
```bash
npm run dev
```

4. **Acessar dashboard**:
```
http://localhost:5173/dashboard
```

---

## ğŸ“Š Exemplos de Uso

### 1. KPIs do Ano Completo

```bash
curl "http://localhost:8000/api/indicadores/kpis?ano=2024" \
  -H "Authorization: Bearer $TOKEN"
```

**Response**:
```json
{
  "total_casos": {
    "titulo": "Total de Casos",
    "valor": 15234.0,
    "unidade": "casos",
    "variacao": {
      "valor_atual": 15234.0,
      "valor_anterior": 12450.0,
      "variacao_absoluta": 2784.0,
      "variacao_percentual": 22.36,
      "tendencia": "alta"
    },
    "icone": "Activity",
    "cor": "#FF6B6B"
  },
  ...
}
```

### 2. SÃ©rie Temporal Mensal de Dengue

```bash
curl "http://localhost:8000/api/indicadores/series-temporais?ano=2024&periodo_agregacao=mensal&doenca_tipo=DENGUE"
```

**Response**:
```json
{
  "series": [
    {
      "nome": "Casos DENGUE 2024",
      "tipo": "casos",
      "unidade": "casos",
      "dados": [
        {"data": "2024-01", "valor": 1523.0},
        {"data": "2024-02", "valor": 1687.0}
      ],
      "cor": "#FF6B6B"
    }
  ],
  "periodo_agregacao": "mensal",
  "total_pontos": 10
}
```

### 3. Top 10 MunicÃ­pios por IncidÃªncia

```bash
curl "http://localhost:8000/api/indicadores/top?ano=2024&tipo_indicador=incidencia&limite=10"
```

**Response**:
```json
{
  "ranking": [
    {
      "posicao": 1,
      "codigo_ibge": "5103403",
      "nome": "CuiabÃ¡",
      "valor": 622.04,
      "percentual": 25.23,
      "nivel_risco": "MUITO_ALTO",
      "cor_hex": "#F44336"
    }
  ],
  "tipo_indicador": "incidencia",
  "unidade": "/100k hab",
  "total_items": 141,
  "limite": 10
}
```

---

## ğŸ¨ UI/UX Features

### Cards KPI
- Design limpo e moderno
- Cores representando nÃ­veis de risco
- Ãcones intuitivos (Lucide React)
- Setas de tendÃªncia (â†‘ â†“ â†’)
- Tooltips com descriÃ§Ãµes

### GrÃ¡ficos
- **Linha**: EvoluÃ§Ã£o temporal, mÃºltiplas sÃ©ries, zoom/pan
- **Barras**: Rankings, cores por risco, drill-down (futuro)

### Filtros
- Seletores dropdown estilizados
- Inputs numÃ©ricos para semanas
- AplicaÃ§Ã£o automÃ¡tica (useEffect)
- Feedback visual durante loading

### Responsividade
- Grid adaptativo (1-4 colunas)
- Layout mobile-friendly
- Breakpoints TailwindCSS
- Touch-friendly para tablets

---

## ğŸ“ˆ MÃ©tricas M1.3

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘            M1.3 - DASHBOARD EPI - COMPLETO âœ…                  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                â•‘
â•‘  Status:          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100% âœ…                â•‘
â•‘  DuraÃ§Ã£o:         1 hora                                       â•‘
â•‘  ConclusÃ£o:       2024-11-02                                   â•‘
â•‘                                                                â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  CÃ³digo Backend:       1.500 linhas        âœ…                  â•‘
â•‘  CÃ³digo Frontend:        670 linhas        âœ…                  â•‘
â•‘  TOTAL:                2.170 linhas        âœ…                  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Schemas Pydantic:     14 schemas          âœ…                  â•‘
â•‘  Service methods:       5 mÃ©todos          âœ…                  â•‘
â•‘  APIs REST:             3 endpoints        âœ…                  â•‘
â•‘  Componentes React:     4 components       âœ…                  â•‘
â•‘  Arquivos criados:      7 arquivos         âœ…                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ”œ Melhorias Futuras

- [ ] Cache Redis para KPIs (invalidaÃ§Ã£o a cada 5min)
- [ ] Exportar dashboard para PDF
- [ ] Drill-down em municÃ­pios (click no ranking)
- [ ] Comparativos entre municÃ­pios
- [ ] GrÃ¡ficos de pizza (distribuiÃ§Ã£o por faixa etÃ¡ria/sexo)
- [ ] Alertas e notificaÃ§Ãµes (thresholds configurÃ¡veis)
- [ ] Favoritos e dashboards customizados por usuÃ¡rio

---

## ğŸ“ Suporte

**DocumentaÃ§Ã£o Relacionada**:
- `docs/M1_ETL_README.md` - ETL SINAN/LIRAa
- `docs/REPO_STATUS_TECNICO.md` - Status tÃ©cnico geral
- `docs/ROADMAP_VISUAL.md` - Roadmap do projeto

**Equipe TechDengue MT**  
**Data**: 2024-11-02  
**VersÃ£o**: 1.0.0
